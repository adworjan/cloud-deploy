---

- name: "Create GCP Kubernetes Cluster {{ gcp_prefix }}-cluster"
  google.cloud.gcp_container_cluster:
    name: "{{ gcp_prefix }}-cluster"
    initial_node_count: 3
    master_auth:
      client_certificate_config:
        issue_client_certificate: yes
      username: admin
      # password: gwC3aS25ztYsN9U*Y8
    kubectl_path: "{{ working_dir }}/{{gcp_prefix}}-config"
    node_config:
      machine_type: n1-standard-1
      disk_size_gb: 100
    location: "{{ gcp_zone }}"
    state: present
  register: gcp_cluster

- name: create a node pool
  google.cloud.gcp_container_node_pool:
    name: "{{ gcp_prefix }}-pool"
    initial_node_count: 3
    cluster: "{{ gcp_cluster }}"
    location: "{{ gcp_zone }}"
    state: present

# - debug:
#     var: gcp_cluster

- copy:
    content: "{{ gcp_cluster.masterAuth.clientCertificate | b64decode }}"
    dest: "{{ working_dir }}/gcp_cert.crt"
